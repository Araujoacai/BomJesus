<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mercearia Bom Jesus - PDV</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons CDN -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Estilo para a barra de rolagem (opcional, mas melhora a estética) */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #4ade80; /* Tom de verde */
            border-radius: 6px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #22c55e;
        }
        /* Esconde os botões de número no input type=number */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 font-sans">

    <!-- Tela de Login (visível por padrão) -->
    <div id="login-page" class="flex items-center justify-center min-h-screen bg-gray-200">
        <div class="w-full max-w-md p-8 bg-white rounded-lg shadow-xl">
            <h2 class="text-3xl font-bold text-center text-green-700 mb-2">
                Mercearia Bom Jesus
            </h2>
            <p class="text-center text-gray-600 mb-6">Acesse seu painel</p>
            <form id="login-form">
                <div class="mb-4">
                    <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="login-email" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Senha</label>
                    <input type="password" id="login-password" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                </div>
                <div id="login-error" class="text-red-500 text-sm mb-4 hidden"></div>
                <div class="flex flex-col sm:flex-row gap-3">
                    <button type="submit" id="login-btn" class="flex-1 w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition duration-200 font-semibold">
                        Entrar
                    </button>
                    <button type="button" id="register-btn" class="flex-1 w-full bg-gray-200 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-200 font-semibold">
                        Registrar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Container Principal da Aplicação (oculto por padrão) -->
    <div id="app-container" class="hidden md:flex">
        <!-- Sidebar (Navegação) -->
        <nav class="w-full md:w-64 bg-green-800 text-white md:h-screen md:sticky md:top-0 flex md:flex-col justify-between">
            <div class="flex-grow">
                <div class="p-5 text-2xl font-bold border-b border-green-700">
                    Mercearia Bom Jesus
                </div>
                <ul class="nav-links">
                    <!-- Links de navegação -->
                    <li class="nav-link active" data-panel="sales">
                        <i data-lucide="shopping-cart" class="w-5 h-5"></i>
                        <span>Painel de Vendas</span>
                    </li>
                    <li class="nav-link" data-panel="stock">
                        <i data-lucide="boxes" class="w-5 h-5"></i>
                        <span>Estoque</span>
                    </li>
                    <li class="nav-link" data-panel="admin">
                        <i data-lucide="bar-chart-3" class="w-5 h-5"></i>
                        <span>Painel ADM</span>
                    </li>
                </ul>
            </div>
            <!-- Info do Usuário e Logout -->
            <div class="p-4 border-t border-green-700">
                <div id="user-info" class="flex items-center mb-2">
                    <i data-lucide="user" class="w-5 h-5 mr-2"></i>
                    <span id="user-email-display" class="text-sm truncate" title="Usuário">Carregando...</span>
                </div>
                <button id="logout-btn" class="w-full flex items-center justify-center gap-2 bg-green-600 hover:bg-green-700 text-white py-2 px-3 rounded-lg text-sm font-medium transition-colors">
                    <i data-lucide="log-out" class="w-4 h-4"></i>
                    Sair
                </button>
            </div>
            <!-- Navegação Mobile (estilo diferente da barra lateral) -->
            <div class="md:hidden flex justify-around p-2 bg-green-800 fixed bottom-0 left-0 right-0 shadow-lg">
                <button class="nav-link-mobile" data-panel="sales">
                    <i data-lucide="shopping-cart" class="w-6 h-6"></i>
                    <span class="text-xs">Vendas</span>
                </button>
                <button class="nav-link-mobile" data-panel="stock">
                    <i data-lucide="boxes" class="w-6 h-6"></i>
                    <span class="text-xs">Estoque</span>
                </button>
                <button class="nav-link-mobile" data-panel="admin">
                    <i data-lucide="bar-chart-3" class="w-6 h-6"></i>
                    <span class="text-xs">ADM</span>
                </button>
                <button id="logout-btn-mobile" class="nav-link-mobile">
                    <i data-lucide="log-out" class="w-6 h-6"></i>
                    <span class="text-xs">Sair</span>
                </button>
            </div>
        </nav>

        <!-- Conteúdo Principal -->
        <main class="flex-1 p-4 sm:p-6 lg:p-8 bg-gray-100 min-h-screen mb-16 md:mb-0">
            <!-- Painel de Vendas (PDV) -->
            <div id="sales-panel" class="app-panel">
                <h1 class="text-3xl font-bold mb-6 text-gray-800">Painel de Vendas (PDV)</h1>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    
                    <!-- Coluna da Esquerda: Busca e Carrinho -->
                    <div class="lg:col-span-2 space-y-6">
                        <!-- Busca de Itens -->
                        <div class="bg-white p-5 rounded-lg shadow">
                            <h2 class="text-xl font-semibold mb-3">Buscar Item</h2>
                            <div class="flex gap-2">
                                <i data-lucide="search" class="text-gray-400 mt-2.5"></i>
                                <input type="text" id="sales-search-input" placeholder="Digite o nome ou código do produto..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            </div>
                            <!-- Resultados da Busca -->
                            <div id="sales-search-results" class="mt-4 max-h-60 overflow-y-auto divide-y divide-gray-100">
                                <!-- Itens aparecerão aqui via JS -->
                            </div>
                        </div>

                        <!-- Carrinho de Compras -->
                        <div class="bg-white p-5 rounded-lg shadow">
                            <h2 class="text-xl font-semibold mb-3">Carrinho</h2>
                            <div id="cart-items" class="divide-y divide-gray-200">
                                <!-- Itens do carrinho aparecerão aqui -->
                                <p id="cart-empty-msg" class="text-gray-500 py-4">O carrinho está vazio.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Coluna da Direita: Resumo e Pagamento -->
                    <div class="lg:col-span-1">
                        <div class="bg-white p-5 rounded-lg shadow lg:sticky lg:top-8">
                            <h2 class="text-xl font-semibold mb-4">Resumo da Venda</h2>
                            <div class="space-y-3 mb-4">
                                <div class="flex justify-between text-lg">
                                    <span>Subtotal</span>
                                    <span id="cart-subtotal">R$ 0,00</span>
                                </div>
                                <div class="flex justify-between text-lg">
                                    <span>Desconto</span>
                                    <span>R$ 0,00</span>
                                </div>
                                <div class="flex justify-between text-2xl font-bold text-green-700 pt-2 border-t">
                                    <span>TOTAL</span>
                                    <span id="cart-total">R$ 0,00</span>
                                </div>
                            </div>

                            <h3 class="text-lg font-semibold mt-6 mb-3">Forma de Pagamento</h3>
                            <div class="grid grid-cols-2 gap-3">
                                <button class="payment-option-btn" data-method="dinheiro">
                                    <i data-lucide="banknote" class="w-5 h-5"></i> Dinheiro
                                </button>
                                <button class="payment-option-btn" data-method="cartao">
                                    <i data-lucide="credit-card" class="w-5 h-5"></i> Cartão
                                </button>
                                <button class="payment-option-btn" data-method="pix">
                                    <i data-lucide="smartphone" class="w-5 h-5"></i> PIX
                                </button>
                                <button class="payment-option-btn" data-method="fiado">
                                    <i data-lucide="notebook-pen" class="w-5 h-5"></i> Fiado
                                </button>
                            </div>
                            <input type="hidden" id="payment-method-input">

                            <!-- Campo para "Dinheiro" -->
                            <div id="dinheiro-details" class="mt-4 hidden space-y-2">
                                <div>
                                    <label for="valor-pago" class="block text-sm font-medium text-gray-700">Valor Pago</label>
                                    <input type="number" id="valor-pago" placeholder="R$ 0,00" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                                </div>
                                <div class="text-lg font-medium">
                                    <span>Troco: </span>
                                    <span id="troco-display" class="font-bold text-blue-600">R$ 0,00</span>
                                </div>
                            </div>
                            
                            <button id="finalize-sale-btn" class="w-full bg-green-600 text-white py-3 px-4 rounded-lg hover:bg-green-700 transition duration-200 font-bold text-lg mt-6 flex items-center justify-center gap-2">
                                <i data-lucide="check-circle" class="w-6 h-6"></i>
                                Finalizar Venda
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Painel de Estoque -->
            <div id="stock-panel" class="app-panel hidden">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold text-gray-800">Gerenciamento de Estoque</h1>
                    <button id="show-add-item-modal-btn" class="bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition duration-200 font-semibold flex items-center gap-2">
                        <i data-lucide="plus" class="w-5 h-5"></i>
                        Adicionar Item
                    </button>
                </div>
                
                <!-- Tabela de Estoque -->
                <div class="bg-white rounded-lg shadow overflow-x-auto">
                    <table class="w-full min-w-max">
                        <thead class="bg-gray-50 border-b border-gray-200">
                            <tr>
                                <th class="text-left text-sm font-medium text-gray-500 p-4">Nome</th>
                                <th class="text-left text-sm font-medium text-gray-500 p-4">Preço</th>
                                <th class="text-left text-sm font-medium text-gray-500 p-4">Estoque (Qtd)</th>
                                <th class="text-left text-sm font-medium text-gray-500 p-4">Cód. Barras</th>
                                <th class="text-left text-sm font-medium text-gray-500 p-4">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="stock-table-body" class="divide-y divide-gray-100">
                            <!-- Linhas do estoque serão inseridas aqui via JS -->
                            <tr><td colspan="5" class="p-4 text-center text-gray-500">Carregando estoque...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Painel ADM -->
            <div id="admin-panel" class="app-panel hidden">
                <h1 class="text-3xl font-bold mb-6 text-gray-800">Painel Administrativo</h1>
                
                <!-- Dashboard de Métricas -->
                <h2 class="text-2xl font-semibold mb-4">Dashboard</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                    <div class="bg-white p-5 rounded-lg shadow">
                        <h3 class="text-sm font-medium text-gray-500">Vendas Hoje</h3>
                        <p id="metric-vendas-hoje" class="text-3xl font-bold text-green-700">R$ 0,00</p>
                    </div>
                    <div class="bg-white p-5 rounded-lg shadow">
                        <h3 class="text-sm font-medium text-gray-500">Total de Vendas (Mês)</h3>
                        <p id="metric-vendas-mes" class="text-3xl font-bold text-gray-700">R$ 0,00</p>
                    </div>
                    <div class="bg-white p-5 rounded-lg shadow">
                        <h3 class="text-sm font-medium text-gray-500">Itens Vendidos (Hoje)</h3>
                        <p id="metric-itens-hoje" class="text-3xl font-bold text-gray-700">0</p>
                    </div>
                    <div class="bg-white p-5 rounded-lg shadow">
                        <h3 class="text-sm font-medium text-gray-500">Total de Clientes</h3>
                        <p class="text-3xl font-bold text-gray-700">0</p>
                    </div>
                </div>

                <!-- Gerenciamento de Promoções -->
                <h2 class="text-2xl font-semibold mb-4">Promoções</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-5 rounded-lg shadow">
                        <h3 class="text-xl font-semibold mb-3">Criar Nova Promoção</h3>
                        <form id="promo-form" class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Item (do Estoque)</label>
                                <select id="promo-item-select" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                                    <option>Selecione um item</option>
                                    <!-- Itens do estoque aqui -->
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Preço Promocional</label>
                                <input type="number" id="promo-price" placeholder="R$ 0,00" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            </div>
                            <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-200 font-semibold">
                                Salvar Promoção
                            </button>
                        </form>
                    </div>
                    <div class="bg-white p-5 rounded-lg shadow">
                        <h3 class="text-xl font-semibold mb-3">Promoções Ativas</h3>
                        <div id="active-promos-list" class="space-y-2">
                            <p class="text-gray-500">Nenhuma promoção ativa.</p>
                            <!-- Lista de promoções -->
                        </div>
                    </div>
                </div>


                <!-- Filtros do Histórico de Vendas -->
                <div class="flex flex-wrap items-center justify-between gap-4 mt-8 mb-4">
                    <h2 class="text-2xl font-semibold">Histórico de Vendas</h2>
                    <div class="flex flex-wrap items-center gap-3">
                        <label for="sales-filter-start" class="text-sm font-medium">De:</label>
                        <input type="date" id="sales-filter-start" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                        <label for="sales-filter-end" class="text-sm font-medium">Até:</label>
                        <input type="date" id="sales-filter-end" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                        <button id="filter-sales-btn" class="bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition duration-200 font-semibold flex items-center gap-2">
                            <i data-lucide="filter" class="w-5 h-5"></i>
                            Filtrar
                        </button>
                        <button id="export-csv-btn" class="bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-200 font-semibold flex items-center gap-2" disabled>
                            <i data-lucide="download" class="w-5 h-5"></i>
                            Gerar CSV
                        </button>
                    </div>
                </div>
                
                <!-- Histórico de Vendas -->
                <div class="bg-white rounded-lg shadow overflow-x-auto">
                    <table class="w-full min-w-max">
                        <thead class="bg-gray-50 border-b border-gray-200">
                            <tr>
                                <th class="text-left text-sm font-medium text-gray-500 p-4">Data/Hora</th>
                                <th class="text-left text-sm font-medium text-gray-500 p-4">Itens</th>
                                <th class="text-left text-sm font-medium text-gray-500 p-4">Total</th>
                                <th class="text-left text-sm font-medium text-gray-500 p-4">Pagamento</th>
                            </tr>
                        </thead>
                        <tbody id="sales-history-list" class="divide-y divide-gray-100">
                            <!-- Linhas do histórico serão inseridas aqui via JS -->
                            <tr><td colspan="4" class="p-4 text-center text-gray-500">Use os filtros acima para buscar o histórico de vendas.</td></tr>
                        </tbody>
                    </table>
                </div>

            </div>
        </main>
    </div>

    <!-- Modal para Adicionar/Editar Item (oculto por padrão) -->
    <div id="stock-item-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white w-full max-w-lg p-6 rounded-lg shadow-xl">
            <div class="flex justify-between items-center mb-4">
                <h2 id="modal-title" class="text-2xl font-bold text-gray-800">Adicionar Novo Item</h2>
                <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <form id="stock-item-form" class="space-y-4">
                <input type="hidden" id="item-id-input">
                <div>
                    <label for="item-name" class="block text-sm font-medium text-gray-700">Nome do Item</label>
                    <input type="text" id="item-name" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="item-price" class="block text-sm font-medium text-gray-700">Preço (R$)</label>
                        <input type="number" id="item-price" step="0.01" min="0" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="ex: 10.50">
                    </div>
                    <div>
                        <label for="item-quantity" class="block text-sm font-medium text-gray-700">Quantidade em Estoque</label>
                        <input type="number" id="item-quantity" step="1" min="0" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="ex: 100">
                    </div>
                </div>
                <div>
                    <label for="item-barcode" class="block text-sm font-medium text-gray-700">Código de Barras (Opcional)</label>
                    <input type="text" id="item-barcode" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" id="cancel-modal-btn" class="bg-gray-200 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-200 font-semibold">
                        Cancelar
                    </button>
                    <button type="submit" id="save-item-btn" class="bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition duration-200 font-semibold">
                        Salvar Item
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Mensagem/Notificação -->
    <div id="message-modal" class="fixed top-5 right-5 bg-green-500 text-white p-4 rounded-lg shadow-lg hidden transition-all duration-300 z-50">
        <span id="message-text">Mensagem de sucesso!</span>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Configuração do Firebase que você forneceu
        const firebaseConfig = {
            apiKey: "AIzaSyAIZkllwpsuiVorhvrkS1RxWD1XP3kMSN8",
            authDomain: "merceariapdv.firebaseapp.com",
            projectId: "merceariapdv",
            storageBucket: "merceariapdv.firebasestorage.app",
            messagingSenderId: "187157040060",
            appId: "1:187157040060:web:f1066bf710a33e98af79b9",
            measurementId: "G-VMJ4Q9LLG1"
        };

        // Importações do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword, 
            onAuthStateChanged, 
            signOut 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            addDoc, 
            setDoc, 
            deleteDoc, 
            onSnapshot,
            query,
            where,
            getDocs,
            Timestamp,
            writeBatch
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Inicialização do Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // ID do App (para regras do Firestore)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'merceariapdv';

        // Estado Global
        let currentPanel = 'sales';
        let stockItems = [];
        let salesData = []; // Para o dashboard (últimos 30 dias)
        let filteredSalesData = []; // Para o histórico (resultado da busca)
        let cart = [];
        let promotions = [];
        let currentUserId = null; // <-- CORREÇÃO AQUI! Linha Adicionada
        let dbPaths = { stock: '', sales: '', promotions: '' };
        let stockUnsubscribe = null;
        let salesUnsubscribe = null;
        let promotionsUnsubscribe = null; // <-- NOVO

        // Seletores de DOM
        const loginPage = document.getElementById('login-page');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const loginEmail = document.getElementById('login-email');
        const loginPassword = document.getElementById('login-password');
        const loginBtn = document.getElementById('login-btn');
        const registerBtn = document.getElementById('register-btn');
        const loginError = document.getElementById('login-error');
        const logoutBtn = document.getElementById('logout-btn');
        const logoutBtnMobile = document.getElementById('logout-btn-mobile');
        const userEmailDisplay = document.getElementById('user-email-display');
        const panels = document.querySelectorAll('.app-panel');
        const navLinks = document.querySelectorAll('.nav-link');
        const navLinksMobile = document.querySelectorAll('.nav-link-mobile');

        // Seletores do Painel de Estoque
        const stockTableBody = document.getElementById('stock-table-body');
        const stockItemModal = document.getElementById('stock-item-modal');
        const stockItemForm = document.getElementById('stock-item-form');
        const showAddModalBtn = document.getElementById('show-add-item-modal-btn');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const cancelModalBtn = document.getElementById('cancel-modal-btn');
        const modalTitle = document.getElementById('modal-title');
        const itemIdInput = document.getElementById('item-id-input');
        const itemName = document.getElementById('item-name');
        const itemPrice = document.getElementById('item-price');
        const itemQuantity = document.getElementById('item-quantity');
        const itemBarcode = document.getElementById('item-barcode');

        // Seletores do Painel de Vendas
        const salesSearchInput = document.getElementById('sales-search-input');
        const salesSearchResults = document.getElementById('sales-search-results');
        const cartItemsContainer = document.getElementById('cart-items');
        const cartEmptyMsg = document.getElementById('cart-empty-msg');
        const cartSubtotalEl = document.getElementById('cart-subtotal');
        const cartTotalEl = document.getElementById('cart-total');
        const paymentOptionBtns = document.querySelectorAll('.payment-option-btn');
        const paymentMethodInput = document.getElementById('payment-method-input');
        const dinheiroDetails = document.getElementById('dinheiro-details');
        const valorPagoInput = document.getElementById('valor-pago');
        const trocoDisplay = document.getElementById('troco-display');
        const finalizeSaleBtn = document.getElementById('finalize-sale-btn');
        
        // Seletores do Painel ADM
        const promoItemSelect = document.getElementById('promo-item-select');
        const metricVendasHoje = document.getElementById('metric-vendas-hoje');
        const metricVendasMes = document.getElementById('metric-vendas-mes');
        const metricItensHoje = document.getElementById('metric-itens-hoje');
        const promoForm = document.getElementById('promo-form'); // <-- NOVO
        const activePromosList = document.getElementById('active-promos-list'); // <-- NOVO
        const salesHistoryList = document.getElementById('sales-history-list'); // <-- NOVO
        const salesFilterStart = document.getElementById('sales-filter-start');
        const salesFilterEnd = document.getElementById('sales-filter-end');
        const filterSalesBtn = document.getElementById('filter-sales-btn');
        const exportCsvBtn = document.getElementById('export-csv-btn');
        
        // Modal de Mensagem
        const messageModal = document.getElementById('message-modal');
        const messageText = document.getElementById('message-text');

        // --- Funções de Utilidade ---

        // Formatar para BRL (Reais)
        const formatCurrency = (value) => {
            return parseFloat(value).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        };

        // Mostrar Notificação
        const showMessage = (message, isError = false) => {
            messageText.textContent = message;
            messageModal.classList.remove('hidden', 'bg-green-500', 'bg-red-500');
            messageModal.classList.add(isError ? 'bg-red-500' : 'bg-green-500');
            setTimeout(() => {
                messageModal.classList.add('hidden');
            }, 3000);
        };

        // --- Lógica de Autenticação ---

        // Monitorar estado de autenticação
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Usuário está logado
                currentUserId = user.uid;
                userEmailDisplay.textContent = user.email;
                userEmailDisplay.title = user.email;

                // Definir caminhos do DB
                dbPaths.stock = `/artifacts/${appId}/users/${currentUserId}/stock`;
                dbPaths.sales = `/artifacts/${appId}/users/${currentUserId}/sales`;
                dbPaths.promotions = `/artifacts/${appId}/users/${currentUserId}/promotions`;

                // Mostrar app e esconder login
                loginPage.classList.add('hidden');
                appContainer.classList.remove('hidden');
                
                // Iniciar listeners do Firestore
                attachStockListener();
                attachSalesListener();
                attachPromotionsListener(); // <-- NOVO

                // Navegar para o painel padrão
                navigateTo('sales');
            } else {
                // Usuário está deslogado
                currentUserId = null;
                loginPage.classList.remove('hidden');
                appContainer.classList.add('hidden');

                // Parar listeners
                detachListeners();
                
                // Limpar dados
                stockItems = [];
                cart = [];
                renderStockTable();
                renderCart();
            }
        });

        // Handler de Login
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = loginEmail.value;
            const password = loginPassword.value;
            loginError.classList.add('hidden');
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged cuidará do resto
            } catch (error) {
                console.error("Erro de login:", error.message);
                loginError.textContent = "Email ou senha inválidos.";
                loginError.classList.remove('hidden');
            }
        });

        // Handler de Registro
        registerBtn.addEventListener('click', async () => {
            const email = loginEmail.value;
            const password = loginPassword.value;
            
            if (!email || !password) {
                loginError.textContent = "Preencha email e senha para registrar.";
                loginError.classList.remove('hidden');
                return;
            }
            
            loginError.classList.add('hidden');
            
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged cuidará do resto
                showMessage("Conta registrada com sucesso! Você está logado.");
            } catch (error) {
                console.error("Erro de registro:", error.message);
                if (error.code === 'auth/weak-password') {
                    loginError.textContent = "Senha fraca. Use pelo menos 6 caracteres.";
                } else if (error.code === 'auth/email-already-in-use') {
                    loginError.textContent = "Este email já está em uso.";
                } else {
                    loginError.textContent = "Erro ao registrar.";
                }
                loginError.classList.remove('hidden');
            }
        });

        // Handler de Logout
        const handleLogout = async () => {
            try {
                await signOut(auth);
            } catch (error)
            {
                console.error("Erro ao sair:", error);
                showMessage("Erro ao tentar sair.", true);
            }
        };
        logoutBtn.addEventListener('click', handleLogout);
        logoutBtnMobile.addEventListener('click', handleLogout);

        // --- Lógica de Navegação ---

        const navigateTo = (panelId) => {
            // Esconde todos os painéis
            panels.forEach(panel => panel.classList.add('hidden'));
            // Mostra o painel correto
            document.getElementById(`${panelId}-panel`).classList.remove('hidden');

            // Atualiza links da sidebar (desktop)
            navLinks.forEach(link => {
                if (link.dataset.panel === panelId) {
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            });
            
            // Atualiza links da barra inferior (mobile)
            navLinksMobile.forEach(link => {
                if (link.dataset.panel === panelId) {
                    link.classList.add('active-mobile');
                } else {
                    link.classList.remove('active-mobile');
                }
            });

            currentPanel = panelId;
        };

        // Adiciona listeners aos links de navegação
        [...navLinks, ...navLinksMobile].forEach(link => {
            if(link.dataset.panel) {
                link.addEventListener('click', (e) => {
                    const panelId = e.currentTarget.dataset.panel;
                    navigateTo(panelId);
                });
            }
        });

        // --- Lógica de Listeners do Firestore ---

        const attachStockListener = () => {
            if (stockUnsubscribe) stockUnsubscribe(); // Cancela listener anterior
            if (!currentUserId) return;

            const q = query(collection(db, dbPaths.stock));
            stockUnsubscribe = onSnapshot(q, (snapshot) => {
                stockItems = [];
                snapshot.forEach((doc) => {
                    stockItems.push({ id: doc.id, ...doc.data() });
                });
                stockItems.sort((a, b) => a.name.localeCompare(b.name)); // Ordena alfabeticamente
                
                // Re-renderiza componentes que dependem do estoque
                renderStockTable();
                renderSalesItemSearch(); // <-- Chamada importante
                updatePromoItemSelect();
                
            }, (error) => {
                console.error("Erro ao buscar estoque:", error);
                showMessage("Erro ao carregar estoque.", true);
            });
        };
        
        const attachSalesListener = () => {
            if (salesUnsubscribe) salesUnsubscribe();
            if (!currentUserId) return;

            // Pega vendas dos últimos 30 dias para o dashboard
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            const q = query(
                collection(db, dbPaths.sales),
                where('timestamp', '>=', Timestamp.fromDate(thirtyDaysAgo))
            );

            salesUnsubscribe = onSnapshot(q, (snapshot) => {
                salesData = [];
                snapshot.forEach((doc) => {
                    salesData.push({ id: doc.id, ...doc.data() });
                });
                
                // Atualiza o dashboard
                renderDashboard();
                // REMOVIDO: renderSalesHistory();
                
            }, (error) => {
                console.error("Erro ao buscar vendas:", error);
            });
        };

        const attachPromotionsListener = () => { // <-- BLOCO NOVO
            if (promotionsUnsubscribe) promotionsUnsubscribe();
            if (!currentUserId) return;

            const q = query(collection(db, dbPaths.promotions));
            promotionsUnsubscribe = onSnapshot(q, (snapshot) => {
                promotions = [];
                snapshot.forEach((doc) => {
                    // Usamos o ID do doc como itemId, pois o definimos assim
                    promotions.push({ itemId: doc.id, ...doc.data() }); 
                });
                
                // Re-renderiza a lista de promoções ativas
                renderActivePromotions();
                // Re-renderiza a busca de vendas (para mostrar preços de promo)
                if (salesSearchInput) {
                    renderSalesItemSearch(salesSearchInput.value);
                }

            }, (error) => {
                console.error("Erro ao buscar promoções:", error);
            });
        };

        const detachListeners = () => {
            if (stockUnsubscribe) {
                stockUnsubscribe();
                stockUnsubscribe = null;
            }
            if (salesUnsubscribe) {
                salesUnsubscribe();
                salesUnsubscribe = null;
            }
            if (promotionsUnsubscribe) { // <-- NOVO
                promotionsUnsubscribe();
                promotionsUnsubscribe = null;
            }
        };


        // --- Lógica do Painel de Estoque (CRUD) ---

        // Renderizar tabela de estoque
        const renderStockTable = () => {
            if (!stockTableBody) return;
            if (stockItems.length === 0) {
                stockTableBody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-500">Nenhum item cadastrado no estoque.</td></tr>';
                return;
            }
            
            stockTableBody.innerHTML = stockItems.map(item => `
                <tr class="hover:bg-gray-50">
                    <td class="p-4 text-sm font-medium text-gray-900">${item.name}</td>
                    <td class="p-4 text-sm text-gray-600">${formatCurrency(item.price)}</td>
                    <td class="p-4 text-sm text-gray-600">${item.quantity}</td>
                    <td class="p-4 text-sm text-gray-600">${item.barcode || 'N/A'}</td>
                    <td class="p-4 text-sm text-gray-600 space-x-2">
                        <button class="edit-item-btn text-blue-600 hover:text-blue-800" data-id="${item.id}">
                            <i data-lucide="edit" class="w-5 h-5"></i>
                        </button>
                        <button class="delete-item-btn text-red-600 hover:text-red-800" data-id="${item.id}">
                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            lucide.createIcons(); // Recria ícones de editar/deletar
        };

        // Abrir/Fechar Modal de Item
        const openStockModal = (item = null) => {
            stockItemForm.reset();
            itemIdInput.value = '';
            if (item) {
                // Modo Edição
                modalTitle.textContent = "Editar Item";
                itemIdInput.value = item.id;
                itemName.value = item.name;
                itemPrice.value = item.price;
                itemQuantity.value = item.quantity;
                itemBarcode.value = item.barcode || '';
            } else {
                // Modo Adição
                modalTitle.textContent = "Adicionar Novo Item";
            }
            stockItemModal.classList.remove('hidden');
        };

        const closeStockModal = () => {
            stockItemModal.classList.add('hidden');
            stockItemForm.reset();
            itemIdInput.value = '';
        };

        showAddModalBtn.addEventListener('click', () => openStockModal());
        closeModalBtn.addEventListener('click', closeStockModal);
        cancelModalBtn.addEventListener('click', closeStockModal);

        // Salvar (Adicionar ou Editar) Item
        stockItemForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = itemIdInput.value;
            const itemData = {
                name: itemName.value,
                price: parseFloat(itemPrice.value),
                quantity: parseInt(itemQuantity.value),
                barcode: itemBarcode.value || '',
                // Normaliza o nome para busca
                searchName: itemName.value.toLowerCase()
            };

            if (isNaN(itemData.price) || isNaN(itemData.quantity)) {
                showMessage("Preço e Quantidade devem ser números válidos.", true);
                return;
            }

            // <-- **** CORREÇÃO AQUI **** -->
            // O bloco try/catch para salvar o item estava faltando e 
            // a lógica de renderização de busca estava no lugar errado.
            try {
                if (id) {
                    // Atualizar
                    const itemRef = doc(db, dbPaths.stock, id);
                    await setDoc(itemRef, itemData);
                    showMessage("Item atualizado com sucesso!");
                } else {
                    // Adicionar
                    await addDoc(collection(db, dbPaths.stock), itemData);
                    showMessage("Item adicionado com sucesso!");
                }
                closeStockModal();
            } catch (error) {
                console.error("Erro ao salvar item:", error);
                showMessage("Erro ao salvar item.", true);
            }
            // <-- **** FIM DA CORREÇÃO **** -->
        });

        // Deletar Item
        stockTableBody.addEventListener('click', async (e) => {
            const deleteBtn = e.target.closest('.delete-item-btn');
            if (deleteBtn) {
                const id = deleteBtn.dataset.id;
                // NOTA: Em um app real, use um modal de confirmação em vez de `confirm`.
                // Mas `confirm` é bloqueado em iframes, então vamos deletar direto.
                // if (confirm("Tem certeza que deseja deletar este item?")) { ... }
                
                // Vamos usar uma simples confirmação improvisada
                const row = deleteBtn.closest('tr');
                row.classList.add('bg-red-200');
                showMessage("Clique novamente para confirmar a exclusão.", true);

                const confirmDelete = async () => {
                    try {
                        await deleteDoc(doc(db, dbPaths.stock, id));
                        showMessage("Item deletado com sucesso.");
                    } catch (error) {
                        console.error("Erro ao deletar item:", error);
                        showMessage("Erro ao deletar item.", true);
                        row.classList.remove('bg-red-200');
                    }
                    deleteBtn.removeEventListener('click', confirmDelete);
                };
                
                // Adiciona um listener de "clique de confirmação"
                deleteBtn.addEventListener('click', confirmDelete, { once: true });
                
                // Reseta se o usuário não clicar de novo em 3s
                setTimeout(() => {
                    deleteBtn.removeEventListener('click', confirmDelete);
                    row.classList.remove('bg-red-200');
                }, 3000);

            }
            
            const editBtn = e.target.closest('.edit-item-btn');
            if (editBtn) {
                const id = editBtn.dataset.id;
                const item = stockItems.find(i => i.id === id);
                if (item) {
                    openStockModal(item);
                }
            }
        });


        // --- Lógica do Painel de Vendas (PDV) ---

        // <-- **** CORREÇÃO AQUI **** -->
        // A definição da função renderSalesItemSearch estava faltando
        // Renderizar resultados da busca
        const renderSalesItemSearch = (filter = "") => {
            const lowerFilter = (filter || "").toLowerCase();
            const filteredItems = stockItems.filter(item => 
                (item.name.toLowerCase().includes(lowerFilter) || 
                 item.barcode === filter) &&
                item.quantity > 0
            );

            if (filteredItems.length === 0) {
                salesSearchResults.innerHTML = '<p class="p-3 text-gray-500">Nenhum item encontrado.</p>';
                return;
            }

            salesSearchResults.innerHTML = filteredItems.map(item => {
                // LÓGICA DE PROMOÇÃO
                const promo = promotions.find(p => p.itemId === item.id);
                const displayPrice = promo ? promo.promoPrice : item.price;
                const originalPriceDisplay = promo 
                    ? `<span class="line-through text-gray-400">${formatCurrency(item.price)}</span>` 
                    : '';

                return `
                <div class="flex justify-between items-center p-3 hover:bg-green-50 rounded-lg cursor-pointer sales-item-result" data-id="${item.id}">
                    <div>
                        <p class="font-medium">${item.name}</p>
                        <p class="text-sm text-gray-500">${originalPriceDisplay} <span class="font-medium ${promo ? 'text-red-600' : 'text-gray-600'}">${formatCurrency(displayPrice)}</span> - ${item.quantity} em estoque</p>
                    </div>
                    <button class="text-green-600 hover:text-green-800">
                        <i data-lucide="plus-circle" class="w-6 h-6"></i>
                    </button>
                </div>
            `}).join('');
            lucide.createIcons();
        };
        // <-- **** FIM DA CORREÇÃO **** -->

        // Event listener do input de busca
        salesSearchInput.addEventListener('input', (e) => {
            renderSalesItemSearch(e.target.value);
        });

        // Adicionar ao carrinho
        salesSearchResults.addEventListener('click', (e) => {
            const itemDiv = e.target.closest('.sales-item-result');
            if (!itemDiv) return;

            const id = itemDiv.dataset.id;
            const stockItem = stockItems.find(i => i.id === id);
            if (!stockItem) return;

            const cartItem = cart.find(i => i.id === id);

            if (cartItem) {
                // Aumenta a quantidade se houver estoque
                if (cartItem.quantity < stockItem.quantity) {
                    cartItem.quantity++;
                } else {
                    showMessage("Quantidade máxima em estoque atingida.", true);
                }
            } else {
                // Adiciona novo item ao carrinho
                // LÓGICA DE PROMOÇÃO
                const promo = promotions.find(p => p.itemId === stockItem.id);
                if (promo) {
                    cart.push({ 
                        ...stockItem, 
                        quantity: 1, 
                        originalPrice: stockItem.price, // Salva o preço original
                        price: promo.promoPrice, // Sobrescreve o preço
                        isPromo: true 
                    });
                } else {
                    cart.push({ ...stockItem, quantity: 1, isPromo: false, originalPrice: stockItem.price });
                }
            }
            
            renderCart();
            salesSearchInput.value = '';
            renderSalesItemSearch();
        });

        // Renderizar o carrinho
        const renderCart = () => {
            if (cart.length === 0) {
                cartEmptyMsg.classList.remove('hidden');
                cartItemsContainer.innerHTML = '';
                cartItemsContainer.appendChild(cartEmptyMsg);
            } else {
                cartEmptyMsg.classList.add('hidden');
                cartItemsContainer.innerHTML = cart.map(item => {
                    const stockItem = stockItems.find(i => i.id === item.id);
                    const maxQty = stockItem ? stockItem.quantity : item.quantity;
                    
                    // LÓGICA DE PROMOÇÃO
                    const priceDisplay = item.isPromo
                        ? `<span class="font-bold text-red-600">${formatCurrency(item.price)}</span><br><span class="text-xs line-through text-gray-400">${formatCurrency(item.originalPrice || item.price)}</span>`
                        : `<span class="text-gray-600">${formatCurrency(item.price)}</span>`;

                    return `
                    <div class="flex items-center justify-between py-3">
                        <div class="flex-1">
                            <p class="font-medium">${item.name}</p>
                            <p class="text-sm">${priceDisplay}</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <button class="cart-qty-btn" data-id="${item.id}" data-op="-1" ${item.quantity <= 1 ? 'disabled' : ''}>
                                <i data-lucide="minus-circle" class="w-5 h-5 ${item.quantity <= 1 ? 'text-gray-300' : 'text-red-500'}"></i>
                            </button>
                            <input type="number" value="${item.quantity}" class="cart-qty-input w-12 text-center font-semibold" data-id="${item.id}" data-max="${maxQty}">
                            <button class="cart-qty-btn" data-id="${item.id}" data-op="1" ${item.quantity >= maxQty ? 'disabled' : ''}>
                                <i data-lucide="plus-circle" class="w-5 h-5 ${item.quantity >= maxQty ? 'text-gray-300' : 'text-green-500'}"></i>
                            </button>
                        </div>
                        <span class="w-20 text-right font-medium">${formatCurrency(item.price * item.quantity)}</span>
                        <button class="cart-remove-btn ml-3 text-gray-400 hover:text-red-600" data-id="${item.id}">
                            <i data-lucide="trash" class="w-5 h-5"></i>
                        </button>
                    </div>
                `}).join('');
                lucide.createIcons();
            }
            updateCartTotal();
        };

        // Atualizar total do carrinho
        const updateCartTotal = () => {
            const subtotal = cart.reduce((acc, item) => acc + (item.price * item.quantity), 0);
            cartSubtotalEl.textContent = formatCurrency(subtotal);
            cartTotalEl.textContent = formatCurrency(subtotal);
            
            // Atualiza cálculo do troco se necessário
            if (paymentMethodInput.value === 'dinheiro') {
                updateTroco();
            }
        };

        // Event listeners do carrinho (mudar qtd, remover)
        cartItemsContainer.addEventListener('click', (e) => {
            const qtyBtn = e.target.closest('.cart-qty-btn');
            const removeBtn = e.target.closest('.cart-remove-btn');

            if (qtyBtn) {
                const id = qtyBtn.dataset.id;
                const op = parseInt(qtyBtn.dataset.op);
                const item = cart.find(i => i.id === id);
                if (item) {
                    const stockItem = stockItems.find(i => i.id === id);
                    const newQty = item.quantity + op;
                    if (newQty > 0 && newQty <= stockItem.quantity) {
                        item.quantity = newQty;
                    }
                }
                renderCart();
            }

            if (removeBtn) {
                const id = removeBtn.dataset.id;
                cart = cart.filter(item => item.id !== id);
                renderCart();
            }
        });
        
        // Listener para mudança manual de Qtd no carrinho
        cartItemsContainer.addEventListener('change', (e) => {
            const qtyInput = e.target.closest('.cart-qty-input');
            if (qtyInput) {
                const id = qtyInput.dataset.id;
                const maxQty = parseInt(qtyInput.dataset.max);
                let newQty = parseInt(qtyInput.value);
                const item = cart.find(i => i.id === id);
                
                if (isNaN(newQty) || newQty < 1) {
                    newQty = 1;
                }
                if (newQty > maxQty) {
                    newQty = maxQty;
                    showMessage(`Estoque máximo para este item é ${maxQty}.`, true);
                }
                
                item.quantity = newQty;
                qtyInput.value = newQty; // Garante que o input mostre o valor corrigido
                renderCart();
            }
        });

        // Lógica de Pagamento
        paymentOptionBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                // Remove seleção de todos
                paymentOptionBtns.forEach(b => b.classList.remove('active-payment'));
                // Adiciona seleção ao clicado
                btn.classList.add('active-payment');
                const method = btn.dataset.method;
                paymentMethodInput.value = method;

                // Mostra/esconde detalhes de "Dinheiro"
                if (method === 'dinheiro') {
                    dinheiroDetails.classList.remove('hidden');
                } else {
                    dinheiroDetails.classList.add('hidden');
                }
            });
        });
        
        // Lógica do Troco
        const updateTroco = () => {
            const total = cart.reduce((acc, item) => acc + (item.price * item.quantity), 0);
            const pago = parseFloat(valorPagoInput.value) || 0;
            const troco = pago - total;
            
            if (troco > 0) {
                trocoDisplay.textContent = formatCurrency(troco);
            } else {
                trocoDisplay.textContent = "R$ 0,00";
            }
        };
        valorPagoInput.addEventListener('input', updateTroco);

        // Finalizar Venda
        finalizeSaleBtn.addEventListener('click', async () => {
            if (cart.length === 0) {
                showMessage("O carrinho está vazio.", true);
                return;
            }

            const paymentMethod = paymentMethodInput.value;
            if (!paymentMethod) {
                showMessage("Selecione uma forma de pagamento.", true);
                return;
            }

            const total = cart.reduce((acc, item) => acc + (item.price * item.quantity), 0);
            
            // Prepara o objeto da venda
            const saleData = {
                items: cart.map(item => ({
                    id: item.id,
                    name: item.name,
                    price: item.price,
                    quantity: item.quantity,
                })),
                total: total,
                paymentMethod: paymentMethod,
                timestamp: Timestamp.now()
            };

            // Prepara a atualização do estoque (batch write)
            const batch = writeBatch(db);
            let errorInStock = false;
            
            for (const item of cart) {
                const stockItemRef = doc(db, dbPaths.stock, item.id);
                const stockItem = stockItems.find(i => i.id === item.id);
                
                if (!stockItem || stockItem.quantity < item.quantity) {
                    showMessage(`Estoque insuficiente para ${item.name}.`, true);
                    errorInStock = true;
                    break;
                }
                
                const newQuantity = stockItem.quantity - item.quantity;
                batch.update(stockItemRef, { quantity: newQuantity });
            }

            if (errorInStock) {
                return; // Para a execução se o estoque for insuficiente
            }

            try {
                // Adiciona a venda
                await addDoc(collection(db, dbPaths.sales), saleData);
                
                // Commita a atualização do estoque
                await batch.commit();

                // Limpa o PDV
                cart = [];
                renderCart();
                paymentOptionBtns.forEach(b => b.classList.remove('active-payment'));
                paymentMethodInput.value = '';
                dinheiroDetails.classList.add('hidden');
                valorPagoInput.value = '';
                trocoDisplay.textContent = 'R$ 0,00';
                
                showMessage("Venda finalizada com sucesso!");
                
            } catch (error) {
                console.error("Erro ao finalizar venda:", error);
                showMessage("Erro ao finalizar venda. Verifique o estoque.", true);
            }
        });


        // --- Lógica do Painel ADM ---
        
        // Atualiza o select de promoções
        const updatePromoItemSelect = () => {
            if (promoItemSelect) {
                promoItemSelect.innerHTML = '<option value="">Selecione um item</option>';
                stockItems.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.id;
                    option.textContent = `${item.name} (${formatCurrency(item.price)})`;
                    promoItemSelect.appendChild(option);
                });
            }
        };

        // Renderiza o Dashboard (chamado pelo listener de vendas)
        const renderDashboard = () => {
            const today = new Date();
            const startOfToday = new Date(today.setHours(0, 0, 0, 0));
            
            const vendasHoje = salesData.filter(sale => {
                const saleDate = sale.timestamp.toDate();
                return saleDate >= startOfToday;
            });
            
            const totalHoje = vendasHoje.reduce((acc, sale) => acc + sale.total, 0);
            const itensHoje = vendasHoje.reduce((acc, sale) => acc + sale.items.reduce((iAcc, i) => iAcc + i.quantity, 0), 0);
            const totalMes = salesData.reduce((acc, sale) => acc + sale.total, 0);

            metricVendasHoje.textContent = formatCurrency(totalHoje);
            metricItensHoje.textContent = itensHoje;
            metricVendasMes.textContent = formatCurrency(totalMes);
            // Métricas de clientes precisariam de uma coleção de 'clientes'
        };

        // Renderiza o Histórico de Vendas
        const renderSalesHistory = () => { // <-- BLOCO NOVO
            if (!salesHistoryList) return;

            // Renderiza a partir do filteredSalesData, não do salesData
            if (filteredSalesData.length === 0) {
                salesHistoryList.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-gray-500">Nenhuma venda encontrada para este período.</td></tr>';
                exportCsvBtn.disabled = true; // Desabilita botão CSV se não houver dados
                return;
            }

            // Ordena as vendas da mais recente para a mais antiga
            const sortedSales = [...filteredSalesData].sort((a, b) => b.timestamp.toDate() - a.timestamp.toDate());

            salesHistoryList.innerHTML = sortedSales.map(sale => {
                const saleDate = sale.timestamp.toDate().toLocaleString('pt-BR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                const itemsList = sale.items.map(item => `
                    <div class="text-xs">${item.quantity}x ${item.name} (${formatCurrency(item.price)})</div>
                `).join('');

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="p-4 text-sm text-gray-600 whitespace-nowrap">${saleDate}</td>
                        <td class="p-4 text-sm text-gray-600">${itemsList}</td>
                        <td class="p-4 text-sm font-medium text-gray-900">${formatCurrency(sale.total)}</td>
                        <td class="p-4 text-sm text-gray-600 capitalize">${sale.paymentMethod}</td>
                    </tr>
                `;
            }).join('');
            
            exportCsvBtn.disabled = false; // Habilita o botão CSV
        };

        // --- NOVAS FUNÇÕES PARA PROMOÇÕES ---

        // Renderiza a lista de promoções ativas no Painel ADM
        const renderActivePromotions = () => {
            if (!activePromosList) return;
            if (promotions.length === 0) {
                activePromosList.innerHTML = '<p class="text-gray-500">Nenhuma promoção ativa.</p>';
                return;
            }
            
            activePromosList.innerHTML = promotions.map(promo => `
                <div class="flex justify-between items-center p-3 bg-green-50 rounded-lg">
                    <div>
                        <p class="font-semibold">${promo.itemName}</p>
                        <p class="text-sm">
                            <span class="line-through text-gray-500">${formatCurrency(promo.originalPrice)}</span>
                            <i data-lucide="arrow-right" class="w-3 h-3 inline-block mx-1"></i>
                            <span class="font-bold text-red-600">${formatCurrency(promo.promoPrice)}</span>
                        </p>
                    </div>
                    <button class="delete-promo-btn text-red-500 hover:text-red-700" data-id="${promo.itemId}">
                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                    </button>
                </div>
            `).join('');
            lucide.createIcons();
        };

        // Salvar nova promoção
        if (promoForm) {
            promoForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const itemId = promoItemSelect.value;
                const promoPriceInput = document.getElementById('promo-price');
                const promoPrice = parseFloat(promoPriceInput.value);
                
                if (!itemId || isNaN(promoPrice) || promoPrice <= 0) {
                    showMessage("Selecione um item e insira um preço promocional válido.", true);
                    return;
                }
                
                const stockItem = stockItems.find(i => i.id === itemId);
                if (!stockItem) {
                    showMessage("Item de estoque não encontrado.", true);
                    return;
                }
                
                if (promoPrice >= stockItem.price) {
                    showMessage("O preço promocional deve ser menor que o preço original.", true);
                    return;
                }
                
                const promoData = {
                    itemName: stockItem.name,
                    originalPrice: stockItem.price,
                    promoPrice: promoPrice
                };
                
                try {
                    // Usamos o ID do item como ID do documento de promoção para fácil checagem
                    const promoRef = doc(db, dbPaths.promotions, itemId);
                    await setDoc(promoRef, promoData);
                    showMessage("Promoção salva com sucesso!");
                    promoForm.reset();
                } catch (error) {
                    console.error("Erro ao salvar promoção:", error);
                    showMessage("Erro ao salvar promoção.", true);
                }
            });
        }

        // Deletar uma promoção
        if (activePromosList) {
            activePromosList.addEventListener('click', async (e) => {
                const deleteBtn = e.target.closest('.delete-promo-btn');
                if (!deleteBtn) return;
                
                const itemId = deleteBtn.dataset.id;
                const promoDiv = deleteBtn.closest('div');
                promoDiv.classList.add('bg-red-200');
                showMessage("Clique novamente para remover a promoção.", true);

                const confirmDelete = async () => {
                    try {
                        await deleteDoc(doc(db, dbPaths.promotions, itemId));
                        showMessage("Promoção removida com sucesso.");
                        // O onSnapshot vai cuidar de remover da UI
                    } catch (error) {
                        console.error("Erro ao remover promoção:", error);
                        showMessage("Erro ao remover promoção.", true);
                        promoDiv.classList.remove('bg-red-200');
                    }
                    deleteBtn.removeEventListener('click', confirmDelete);
                };
                
                deleteBtn.addEventListener('click', confirmDelete, { once: true });
                
                // Reseta se o usuário não clicar de novo em 3s
                setTimeout(() => {
                    deleteBtn.removeEventListener('click', confirmDelete);
                    if (promoDiv) promoDiv.classList.remove('bg-red-200');
                }, 3000);
            });
        }
        
        // --- FIM DAS NOVAS FUNÇÕES ---

        // --- NOVAS FUNÇÕES PARA FILTRO DE VENDAS E CSV ---

        // Buscar Vendas por Período
        filterSalesBtn.addEventListener('click', async () => {
            const startVal = salesFilterStart.value;
            const endVal = salesFilterEnd.value;

            if (!startVal || !endVal) {
                showMessage("Por favor, selecione data de início e fim.", true);
                return;
            }

            const startDate = new Date(startVal + 'T00:00:00');
            const endDate = new Date(endVal + 'T23:59:59');

            if (endDate < startDate) {
                showMessage("A data final deve ser maior ou igual à data inicial.", true);
                return;
            }

            filterSalesBtn.textContent = 'Buscando...';
            filterSalesBtn.disabled = true;
            exportCsvBtn.disabled = true;

            try {
                const q = query(
                    collection(db, dbPaths.sales),
                    where('timestamp', '>=', Timestamp.fromDate(startDate)),
                    where('timestamp', '<=', Timestamp.fromDate(endDate))
                );

                const querySnapshot = await getDocs(q);
                
                filteredSalesData = [];
                querySnapshot.forEach((doc) => {
                    filteredSalesData.push({ id: doc.id, ...doc.data() });
                });

                renderSalesHistory(); // Renderiza a tabela com os dados filtrados
                showMessage(`Encontradas ${filteredSalesData.length} vendas.`);
            } catch (error) {
                console.error("Erro ao buscar histórico de vendas:", error);
                showMessage("Erro ao buscar histórico.", true);
            }

            filterSalesBtn.innerHTML = '<i data-lucide="filter" class="w-5 h-5"></i> Filtrar';
            lucide.createIcons();
            filterSalesBtn.disabled = false;
        });

        // Gerar CSV
        exportCsvBtn.addEventListener('click', () => {
            if (filteredSalesData.length === 0) {
                showMessage("Não há dados para exportar.", true);
                return;
            }

            // Ordena os dados antes de exportar
            const sortedData = [...filteredSalesData].sort((a, b) => b.timestamp.toDate() - a.timestamp.toDate());

            let csvContent = "data:text/csv;charset=utf-8,";
            // Cabeçalhos (Headers)
            csvContent += "Data,Hora,Itens,Total,Pagamento\r\n";

            // Linhas (Rows)
            sortedData.forEach(sale => {
                const date = sale.timestamp.toDate();
                const dateStr = date.toLocaleString('pt-BR');
                const timeStr = date.toLocaleTimeString('pt-BR');
                // Formata os itens para evitar quebra de linha e vírgulas no CSV
                const items = sale.items.map(i => `${i.quantity}x ${i.name.replace(/"/g, '""')}`).join('; ');
                // Formato de número amigável para Excel (troca ponto por vírgula)
                const total = sale.total.toString().replace('.', ',');
                const payment = sale.paymentMethod;

                csvContent += `"${dateStr}","${timeStr}","${items}","${total}","${payment}"\r\n`;
            });

            // Cria o link de download
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "historico_vendas.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        // --- FIM DAS NOVAS FUNÇÕES ---


        // --- Inicialização ---

        // Ativa os ícones do Lucide
        lucide.createIcons();

        // CSS dinâmico para os links de navegação
        const style = document.createElement('style');
        style.innerHTML = `
            .nav-link {
                display: flex;
                align-items: center;
                gap: 0.75rem; /* 12px */
                padding: 0.75rem 1.25rem; /* 12px 20px */
                cursor: pointer;
                transition: background-color 0.2s;
                font-weight: 500;
            }
            .nav-link:hover {
                background-color: #15803d; /* green-700 */
            }
            .nav-link.active {
                background-color: #16a34a; /* green-600 */
                box-shadow: inset 4px 0 0 0 #fde047; /* yellow-300 */
            }
            
            .nav-link-mobile {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 0.25rem;
                padding: 0.5rem;
                color: #a7f3d0; /* green-200 */
                transition: color 0.2s;
            }
            .nav-link-mobile.active-mobile, .nav-link-mobile:hover {
                color: #ffffff; /* white */
            }
            .nav-link-mobile.active-mobile {
                border-top: 2px solid #fde047; /* yellow-300 */
            }
            
            .payment-option-btn {
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 0.5rem;
                padding: 0.75rem 0.5rem;
                border: 2px solid #d1d5db; /* gray-300 */
                border-radius: 0.5rem; /* 8px */
                font-weight: 600;
                color: #4b5563; /* gray-600 */
                transition: all 0.2s;
            }
            .payment-option-btn:hover {
                border-color: #16a34a; /* green-600 */
                color: #16a34a;
            }
            .payment-option-btn.active-payment {
                border-color: #16a34a; /* green-600 */
                background-color: #dcfce7; /* green-100 */
                color: #15803d; /* green-700 */
                box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            }
            
            /* Estilo para botões desabilitados */
            button:disabled {
                opacity: 0.6;
                cursor: not-allowed;
            }
        `;
        document.head.appendChild(style);

    </script>

</body>
</html>
